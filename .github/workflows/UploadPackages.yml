name: Create CPI Integration Package

on:
  workflow_dispatch:

jobs:
  create-package:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch CSRF Token
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
          CPI_USER: ${{ secrets.CPI_USER }}
          CPI_PASSWORD: ${{ secrets.CPI_PASSWORD }}
        run: |
          curl -s -i \
            -u "$CPI_USER:$CPI_PASSWORD" \
            -H "X-CSRF-Token: Fetch" \
            "$CPI_BASE_URL/api/v1/IntegrationPackages" \
            -c cookies.txt \
            -o response.txt

          grep -i x-csrf-token response.txt | awk '{print $2}' | tr -d '\r' > token.txt

      - name: Create Integration Package
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
          CPI_USER: ${{ secrets.CPI_USER }}
          CPI_PASSWORD: ${{ secrets.CPI_PASSWORD }}
        run: |
          curl -s -X POST \
            -u "$CPI_USER:$CPI_PASSWORD" \
            -H "X-CSRF-Token: $(cat token.txt)" \
            -H "Content-Type: application/json" \
            -b cookies.txt \
            "$CPI_BASE_URL/api/v1/IntegrationPackages" \
            -d '{
              "Id": "FlashPipeDemo_qas",
              "Name": "FlashPipeDemo_QAS",
              "Description": "Test Transport in one Tenant"
            }'
