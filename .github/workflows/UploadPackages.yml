name: Create CPI Integration Package
on:
  workflow_dispatch:
jobs:
  create-integration-package:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # 1. OAuth2 Token von der SAP UAA holen
      # ------------------------------------------------------------
      - name: Get OAuth Token from UAA
        env:
          UAA_TOKEN_URL: ${{ secrets.UAA_TOKEN_URL }}
          UAA_CLIENT_ID: ${{ secrets.secrets.CPI_USER }}
          UAA_CLIENT_SECRET: ${{ secrets.secrets.CPI_PASSWORD }}
        run: |
          curl -s -X POST "$UAA_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "$UAA_CLIENT_ID:$UAA_CLIENT_SECRET" \
            -d "grant_type=client_credentials" \
            | jq -r '.access_token' > oauth_token.txt

          if [ ! -s oauth_token.txt ]; then
            echo "OAuth Token konnte nicht geholt werden"
            exit 1
          fi
          
      # ------------------------------------------------------------
      # 2. X-CSRF-Token von SAP CPI holen (inkl. Cookies)
      # ------------------------------------------------------------
      - name: Fetch X-CSRF Token
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
        run: |
          echo "Fetching CSRF-Token from $CPI_BASE_URL/api/v1/IntegrationPackages"
          RESPONSE=$(curl -s -w "\n%{http_code}" -i \
            -H "Authorization: Bearer $(cat oauth_token.txt)" \
            -H "X-CSRF-Token: Fetch" \
            "$CPI_BASE_URL/api/v1/IntegrationPackages" \
            -c cookies.txt \
            -o response.txt)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "HTTP Status: $HTTP_CODE"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "CSRF-Request fehlgeschlagen. Response Headers:"
            cat response.txt
            exit 1
          fi
          
          # CSRF aus Headers extrahieren (besser als grep, da Headers in response.txt)
          CSRF=$(grep -i x-csrf-token: response.txt | awk '{print $2}' | tr -d '\r')
          echo "$CSRF" > csrf_token.txt
          if [ -z "$CSRF" ]; then
            echo "Kein X-CSRF-Token gefunden. Headers:"
            grep -i csrf response.txt
            cat response.txt
            exit 1
          fi
          echo "CSRF-Token fetched (length: ${#CSRF})"

      # ------------------------------------------------------------
      # 3. POST: Integration Package in Design Time anlegen
      # ------------------------------------------------------------
      - name: Create Integration Package
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
        run: |
          echo "Creating Package at $CPI_BASE_URL/api/v1/IntegrationPackages"
          JSON_BODY='{
            "Name": "MeinPackageViaAPI",
            "ShortText": "Test via API",
            "Description": "Automatisiert angelegt",
            "Vendor": "xAI",
            "Mode": "EDIT"
          }'
          echo "JSON Body: $JSON_BODY"  # Logging des Bodys
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $(cat oauth_token.txt)" \
            -H "X-CSRF-Token: $(cat csrf_token.txt)" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -b cookies.txt \
            "$CPI_BASE_URL/api/v1/IntegrationPackages" \
            -d "$JSON_BODY" \
            -o post_response.json)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ne 201 ]; then  # Erwartet: 201 Created
            echo "Fehler beim Erstellen! Response Body:"
            cat post_response.json
            echo "Headers:"
            curl -s -I -H "Authorization: Bearer $(cat oauth_token.txt)" "$CPI_BASE_URL/api/v1/IntegrationPackages"  # Optional: Extra-Header-Check
            exit 1
          else
            echo "Erfolg! Response:"
            cat post_response.json
          fi
