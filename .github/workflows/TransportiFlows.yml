name: Extract iFlow IDs from CPI Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: 'Technical Package ID (z. B. CloudPlatformAPITestPackage oder GUID)'
        required: true
        type: string

jobs:
  extract-iflow-ids:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # 1. OAuth2 Token holen (Client Credentials Grant)
      # ------------------------------------------------------------
      - name: Get OAuth Token
        env:
          UAA_TOKEN_URL: ${{ secrets.UAA_TOKEN_URL }}
          UAA_CLIENT_ID: ${{ secrets.CPI_USER }}
          UAA_CLIENT_SECRET: ${{ secrets.CPI_PASSWORD }}
        run: |
          echo "Fetching OAuth token..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$UAA_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "$UAA_CLIENT_ID:$UAA_CLIENT_SECRET" \
            -d "grant_type=client_credentials")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Token-Request fehlgeschlagen (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
          
          echo "$BODY" | jq -r '.access_token' > oauth_token.txt
          echo "Token erhalten (Länge: $(wc -c < oauth_token.txt))"

      # ------------------------------------------------------------
      # 2. GET: Alle Designtime Artifacts des Packages abrufen
      # ------------------------------------------------------------
      - name: Get Designtime Artifacts
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
          PACKAGE_ID: ${{ github.event.inputs.package_id }}
        run: |
          echo "Package ID: $PACKAGE_ID"
          
          URL="$CPI_BASE_URL/api/v1/IntegrationPackages('$PACKAGE_ID')/IntegrationDesigntimeArtifacts"
          
          curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $(cat oauth_token.txt)" \
            -H "Accept: application/xml" \
            "$URL" \
            -o artifacts_response.xml
          
          HTTP_STATUS=$(tail -n1 artifacts_response.xml)
          sed -i '$d' artifacts_response.json
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "GET fehlgeschlagen (HTTP $HTTP_STATUS)"
            cat artifacts_response.json
            exit 1
          fi
          
          echo "Response erfolgreich erhalten"

      # ------------------------------------------------------------
      # 3. Alle Artifact-IDs extrahieren (.d.results[].Id)
      # ------------------------------------------------------------
      - name: Extract all Artifact IDs
        run: |
          # Zuerst: HTTP-Status-Code aus der Response-Datei entfernen (falls vorhanden)
          if tail -n1 artifacts_response.json | grep -q '^[0-9]\+$'; then
            sed -i '$d' artifacts_response.json  # Letzte Zeile (Status-Code) löschen
            echo "HTTP-Status-Code entfernt – Datei jetzt sauber"
          fi
          
          # Validierung: Ist es gültiges JSON? (jq --exit-status testet ohne Ausgabe)
          if ! jq empty artifacts_response.json >/dev/null 2>&1; then
            echo "Fehler: artifacts_response.json ist kein gültiges JSON!"
            echo "Erste 100 Zeichen:"
            head -c 100 artifacts_response.json
            exit 1
          fi
          
          # Der korrekte Pfad für deine Response-Struktur
          jq -r '.d.results[] | .Id' artifacts_response.json > artifact_ids.txt
          
          # Robuste Prüfung: Zähle extrahierte Zeilen (sollte >0 sein)
          NUM_IDS=$(wc -l < artifact_ids.txt)
          if [ "$NUM_IDS" -eq 0 ]; then
            echo "Keine IDs gefunden – möglicher Parsing-Fehler"
            echo "jq-Ausgabe (rohe):"
            jq -r '.d.results[] | .Id' artifacts_response.json
            echo "Erste 30 Zeilen der Response:"
            head -n 30 artifacts_response.json
            exit 1
          fi
          
          echo "======================================"
          echo "Extrahierte Artifact-IDs (Anzahl: $NUM_IDS):"
          cat artifact_ids.txt
          echo "======================================"
          echo "Liste gespeichert in: artifact_ids.txt"

      # ------------------------------------------------------------
      # 4. Optional: Übersicht mit Name + Version + Id
      # ------------------------------------------------------------
      - name: Show detailed overview (Id + Name + Version)
        run: |
          echo "Detaillierte Übersicht:"
          jq -r '.d.results[] | [.Id, .Name, .Version] | @tsv' artifacts_response.json | column -t -s $'\t' || echo "Konnte Tabelle nicht formatieren"
