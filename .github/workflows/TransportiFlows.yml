name: Extract iFlow IDs from CPI Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: 'Technical Package ID (z. B. CloudPlatformAPITestPackage oder GUID)'
        required: true
        type: string

jobs:
  extract-iflow-ids:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------------------------------------
      # 1. OAuth2 Token holen (Client Credentials Grant)
      # ------------------------------------------------------------
      - name: Get OAuth Token
        env:
          UAA_TOKEN_URL: ${{ secrets.UAA_TOKEN_URL }}
          UAA_CLIENT_ID: ${{ secrets.CPI_USER }}
          UAA_CLIENT_SECRET: ${{ secrets.CPI_PASSWORD }}
        run: |
          echo "Fetching OAuth token..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$UAA_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -u "$UAA_CLIENT_ID:$UAA_CLIENT_SECRET" \
            -d "grant_type=client_credentials")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Token-Request fehlgeschlagen (HTTP $HTTP_CODE)"
            echo "$BODY"
            exit 1
          fi
          
          echo "$BODY" | jq -r '.access_token' > oauth_token.txt
          echo "Token erhalten (LÃ¤nge: $(wc -c < oauth_token.txt))"

      # ------------------------------------------------------------
      # 2. GET: Alle Designtime Artifacts des Packages abrufen
      # ------------------------------------------------------------
      - name: Get Designtime Artifacts
        env:
          CPI_BASE_URL: ${{ secrets.CPI_BASE_URL }}
          PACKAGE_ID: ${{ github.event.inputs.package_id }}
        run: |
          echo "Package ID: $PACKAGE_ID"
          
          URL="$CPI_BASE_URL/api/v1/IntegrationPackages('$PACKAGE_ID')/IntegrationDesigntimeArtifacts"
          
          curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $(cat oauth_token.txt)" \
            -H "Accept: application/xml" \
            "$URL" \
            -o artifacts_response.xml
          
          HTTP_STATUS=$(tail -n1 artifacts_response.xml)
          sed -i '$d' artifacts_response.xml
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "GET fehlgeschlagen (HTTP $HTTP_STATUS)"
            cat artifacts_response.xml
            exit 1
          fi
          
          echo "Response erfolgreich erhalten"

      # ------------------------------------------------------------
      # 3. d:Id-Werte extrahieren mit Python (Variante 2)
      # ------------------------------------------------------------
      - name: Extract d:Id from Atom XML (Python)
        run: |
          python3 - <<'EOF'
          import xml.etree.ElementTree as ET
          import sys

          ns = {
              'atom': 'http://www.w3.org/2005/Atom',
              'm':   'http://schemas.microsoft.com/ado/2007/08/dataservices/metadata',
              'd':   'http://schemas.microsoft.com/ado/2007/08/dataservices'
          }

          try:
              tree = ET.parse('artifacts_response.xml')
              root = tree.getroot()
              
              ids = []
              for elem in root.findall('.//atom:entry/m:properties/d:Id', ns):
                  if elem.text:
                      ids.append(elem.text.strip())
              
              if not ids:
                  print("Keine <d:Id>-Elemente gefunden.", file=sys.stderr)
                  sys.exit(1)
              
              print("Extrahierte Artifact-IDs:")
              for id_val in ids:
                  print(id_val)
              
              # In Datei speichern
              with open('artifact_ids.txt', 'w') as f:
                  f.write('\n'.join(ids) + '\n')
              
              print(f"\nAnzahl: {len(ids)}")
              print("Gespeichert in: artifact_ids.txt")
              
          except Exception as e:
              print(f"Fehler beim Parsen: {str(e)}", file=sys.stderr)
              sys.exit(1)
          EOF
          
          # Ergebnis im Log anzeigen
          if [ -f artifact_ids.txt ]; then
            echo "======================================"
            echo "Extrahierte IDs:"
            cat artifact_ids.txt
            echo "======================================"
          else
            echo "Fehler: artifact_ids.txt wurde nicht erstellt"
            exit 1
          fi
